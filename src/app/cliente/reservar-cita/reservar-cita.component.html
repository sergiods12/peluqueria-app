<div class="container mt-3">
  <h2>Reservar Cita</h2>

  <form [formGroup]="reservaForm" class="mb-4">
    <div class="row g-3">
      <div class="col-md-4">
        <label for="peluqueria" class="form-label">Peluquería:</label>
        <select id="peluqueria" formControlName="peluqueria" class="form-select" [attr.disabled]="isLoadingPeluquerias ? true : null">
          <option [ngValue]="null" disabled>
            {{ isLoadingPeluquerias ? 'Cargando peluquerías...' : '-- Seleccione Peluquería --' }}
          </option>
          <option *ngFor="let p of peluquerias" [ngValue]="p.id">{{ p.nombre }}</option>
        </select>
        <div *ngIf="reservaForm.get('peluqueria')?.invalid && reservaForm.get('peluqueria')?.touched" class="text-danger small mt-1">
          Debe seleccionar una peluquería.
        </div>
      </div>

      <div class="col-md-4">
        <label for="empleado" class="form-label">Peluquero/a:</label>
        <select id="empleado" formControlName="empleado" class="form-select">
          <option [ngValue]="null" disabled>
            {{ isLoadingEmpleados ? 'Cargando peluqueros...' : (reservaForm.get('peluqueria')?.value ? (empleadosPeluqueria.length > 0 ? '-- Seleccione Peluquero/a --' : 'No hay peluqueros disponibles') : 'Seleccione peluquería primero') }}
          </option>
          <option *ngFor="let e of empleadosPeluqueria" [ngValue]="e.id">{{ e.nombre }} ({{ e.rol }})</option>
        </select>
        <div *ngIf="reservaForm.get('empleado')?.invalid && reservaForm.get('empleado')?.touched" class="text-danger small mt-1">
          Debe seleccionar un peluquero/a.
        </div>
      </div>

      <div class="col-md-4">
        <label for="servicio" class="form-label">Tipo de Servicio:</label>
        <select id="servicio" formControlName="servicio" class="form-select">
          <option [ngValue]="null" disabled>
            {{ isLoadingServicios ? 'Cargando servicios...' : (reservaForm.get('empleado')?.value ? (servicios.length > 0 ? '-- Seleccione Servicio --' : 'No hay servicios disponibles') : 'Seleccione peluquero/a primero') }}
          </option>
          <option *ngFor="let s of servicios" [ngValue]="s.id">{{ s.nombre }} ({{ s.numTramos * 30 }} min)</option>
        </select>
        <div *ngIf="reservaForm.get('servicio')?.invalid && reservaForm.get('servicio')?.touched" class="text-danger small mt-1">
          Debe seleccionar un servicio.
        </div>
      </div>
    </div>
    <div class="row g-3 mt-1">
        <div class="col-md-4">
            <label for="fechaCita" class="form-label">Fecha de la Cita:</label>
            <input type="date" id="fechaCita" class="form-control"
                   formControlName="fechaCita" [min]="minDate"
                   [attr.disabled]="reservaForm.get('fechaCita')?.disabled ? true : null">
            <div *ngIf="reservaForm.get('fechaCita')?.invalid && reservaForm.get('fechaCita')?.touched" class="text-danger small mt-1">
              Debe seleccionar una fecha.
            </div>
          </div>
    </div>
  </form>

  <div *ngIf="reservaForm.get('peluqueria')?.value && reservaForm.get('empleado')?.value && reservaForm.get('fechaCita')?.value && reservaForm.get('servicio')?.value">
    <h4 class="mt-4">Horarios para el {{ reservaForm.get('fechaCita')?.value | date:'dd/MM/yyyy' }}:</h4>

    <div *ngIf="isLoadingTramos" class="alert alert-info mt-3">Cargando horarios...</div>

    <!-- Mensaje cuando no hay tramos y no hay un error específico de carga -->
    <div *ngIf="!isLoadingTramos && tramosParaMostrar.length === 0 && !mensajeError && reservaForm.get('fechaCita')?.value && reservaForm.get('servicio')?.value" class="alert alert-info mt-3">
      No hay horarios disponibles para la fecha y servicio seleccionados, o el empleado no tiene disponibilidad.
    </div>

    <!-- Mensaje cuando hay tramos pero ninguno es un inicio posible para el servicio -->
    <div *ngIf="!isLoadingTramos && tramosParaMostrar.length > 0 && !hayTramosSeleccionables() && !hayTramosSeleccionadosEnUI && !mensajeError" class="alert alert-warning mt-3">
      No hay suficientes horarios consecutivos disponibles que cumplan con la duración del servicio seleccionado. Por favor, elija otro servicio o fecha.
    </div>

    <div class="row row-cols-2 row-cols-sm-3 row-cols-md-4 row-cols-lg-5 g-2 mt-2">
      <div class="col" *ngFor="let tramo of tramosParaMostrar">
        <div class="card h-100 text-center tramo-card"
             [ngClass]="{
               'tramo-available': tramo.estado === 'disponible',
               'tramo-available-clickable': tramo.estado === 'disponible' && tramo.esInicioPosible,
               'tramo-reserved-other': tramo.estado === 'reservadoOtro',
               'tramo-reserved-current': tramo.estado === 'reservadoCurrentUser',
               'tramo-selected': tramo.estado === 'seleccionado',
               'tramo-unavailable': tramo.estado === 'noSeleccionable'
             }"
             (click)="tramo.estado === 'disponible' && tramo.esInicioPosible ? seleccionarTramo(tramo) : null"
             [class.clickable]="tramo.estado === 'disponible' && tramo.esInicioPosible">
          <div class="card-body d-flex flex-column justify-content-center align-items-center">
            <h6 class="card-title mb-1 tramo-time">{{ tramo.horaInicio }}</h6>
            <small *ngIf="tramo.estado === 'disponible' && tramo.esInicioPosible" class="tramo-status status-disponible">Disponible</small>
            <small *ngIf="tramo.estado === 'disponible' && !tramo.esInicioPosible" class="tramo-status status-insufficient">No encaja</small>
            <small *ngIf="tramo.estado === 'reservadoOtro'" class="tramo-status status-reserved-other">Reservado</small>
            <small *ngIf="tramo.estado === 'reservadoCurrentUser'" class="tramo-status status-reserved-current">Tu Reserva</small>
            <small *ngIf="tramo.estado === 'seleccionado'" class="tramo-status status-selected">Seleccionado</small>
            <small *ngIf="tramo.estado === 'noSeleccionable'" class="tramo-status status-unavailable">No disponible</small>
          </div>
        </div>
      </div>
    </div>
    
    <!-- Botones de acción -->
    <div class="mt-4 d-flex justify-content-end gap-2" *ngIf="hayTramosSeleccionadosEnUI">
        <button (click)="cancelarSeleccion()" class="btn btn-outline-secondary">
            Cancelar Selección
        </button>
        <button (click)="confirmarReserva()" class="btn btn-primary" [disabled]="isLoadingTramos">
          <span *ngIf="!isLoadingTramos">Reservar</span>
          <span *ngIf="isLoadingTramos">Reservando...</span>
        </button>
    </div>

    <div *ngIf="mensajeError" class="alert alert-danger mt-3">{{ mensajeError }}</div>
    <div *ngIf="mensajeExito" class="alert alert-success mt-3">{{ mensajeExito }}</div>
  </div>
  <div *ngIf="!(reservaForm.get('peluqueria')?.value && reservaForm.get('empleado')?.value && reservaForm.get('fechaCita')?.value && reservaForm.get('servicio')?.value) && !isLoadingTramos" class="alert alert-secondary mt-3">
    Por favor, complete todos los campos (Peluquería, Peluquero/a, Servicio y Fecha) para ver los horarios.
  </div>
</div>