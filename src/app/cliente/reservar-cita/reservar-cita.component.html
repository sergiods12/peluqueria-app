<!-- src/app/cliente/reservar-cita/reservar-cita.component.html -->
<div class="container mt-3">
  <h2>Reservar Cita</h2>

  <form [formGroup]="reservaForm" class="mb-4">
    <div class="row g-3">
      <!-- Selección de Peluquería -->
      <div class="col-md-4">
        <label for="peluqueria" class="form-label">Peluquería:</label>
        <select id="peluqueria" formControlName="peluqueria" class="form-select" [attr.disabled]="isLoadingPeluquerias ? true : null">
          <option [ngValue]="null" disabled>
            {{ isLoadingPeluquerias ? 'Cargando peluquerías...' : '-- Seleccione Peluquería --' }}
          </option>
          <option *ngFor="let p of peluquerias" [ngValue]="p.id">{{ p.nombre }}</option>
        </select>
      </div>

      <!-- Selección de Empleado -->
      <div class="col-md-4">
        <label for="empleado" class="form-label">Peluquero/a:</label>
        <select id="empleado" formControlName="empleado" class="form-select">
          <option [ngValue]="null" disabled>
            {{ isLoadingEmpleados ? 'Cargando peluqueros...' : (reservaForm.get('peluqueria')?.value ? (empleadosPeluqueria.length > 0 ? '-- Seleccione Peluquero/a --' : 'No hay peluqueros disponibles') : 'Seleccione peluquería primero') }}
          </option>
          <option *ngFor="let e of empleadosPeluqueria" [ngValue]="e.id">{{ e.nombre }} ({{ e.rol }})</option>
        </select>
      </div>

      <!-- Selección de Servicio -->
      <div class="col-md-4">
        <label for="servicio" class="form-label">Tipo de Servicio:</label>
        <select id="servicio" formControlName="servicio" class="form-select">
          <option [ngValue]="null" disabled>
            {{ isLoadingServicios ? 'Cargando servicios...' : (reservaForm.get('empleado')?.value ? (servicios.length > 0 ? '-- Seleccione Servicio --' : 'No hay servicios disponibles') : 'Seleccione peluquero/a primero') }}
          </option>
          <option *ngFor="let s of servicios" [ngValue]="s.id">{{ s.nombre }} ({{ s.numTramos * 30 }} min)</option>
        </select>
      </div>
    </div>

    <!-- Selección de Fecha -->
    <div class="row g-3 mt-1">
      <div class="col-md-4">
        <label for="fechaCita" class="form-label">Fecha de la Cita:</label>
        <input type="date" id="fechaCita" class="form-control" formControlName="fechaCita" [min]="minDate"
               [attr.disabled]="reservaForm.get('fechaCita')?.disabled ? true : null">
      </div>
    </div>
  </form>

  <!-- Visualización de Tramos como tarjetas -->
  <div *ngIf="reservaForm.valid">
    <h4 class="mt-4">Horarios para el {{ reservaForm.get('fechaCita')?.value | date:'dd/MM/yyyy' }}:</h4>

    <div *ngIf="isLoadingTramos" class="alert alert-info mt-3">Cargando horarios...</div>

    <div *ngIf="!isLoadingTramos && tramosParaMostrar.length === 0 && !mensajeError" class="alert alert-info mt-3">
      No hay tramos definidos por el empleado para esta fecha o no se pudo cargar la disponibilidad.
    </div>

    <div *ngIf="!isLoadingTramos && tramosParaMostrar.length > 0">
      <div class="row mt-3">
        <div *ngFor="let tramo of tramosParaMostrar" class="col-6 col-sm-4 col-md-3 col-lg-2 mb-3">
          <div class="tramo-card"
            [ngStyle]="getColor(tramo)" 
            [ngClass]="{
              'tramo-unavailable': tramo.estado === 'noSeleccionable',
              'tramo-available-clickable': tramo.estado === 'disponible' && tramo.esInicioPosible,
              'tramo-available-not-clickable': tramo.estado === 'disponible' && !tramo.esInicioPosible,
              'tramo-reserved': tramo.estado === 'reservadoOtro',
              'tramo-selected': tramo.estado === 'seleccionado' || tramo.estado === 'reservadoPropio'
            }"
     [title]="getTramoTitle(tramo)"
     (click)="seleccionarTramo(tramo)">

            <div class="card-body">
              <div class="tramo-time">{{ tramo.horaInicio }}</div>
              <div class="tramo-status">{{ getTramoTitle(tramo) }}</div>
            </div>
          </div>
        </div>
      </div>

      <!-- Botones de Acción -->
      <div class="acciones mt-4">
        <button (click)="cancelarSeleccion()" class="btn btn-warning me-2">Cancelar Selección</button>
        <button [disabled]="getTramosSeleccionados().length === 0 || isConfirmingReserva || !reservaForm.valid"
                (click)="confirmarReserva()" class="btn btn-success">
          {{ isConfirmingReserva ? 'Confirmando...' : 'Reservar' }}
        </button>
      </div>
    </div>

    <!-- Mensajes -->
    <div *ngIf="mensajeError" class="alert alert-danger mt-3">{{ mensajeError }}</div>
    <div *ngIf="mensajeExito" class="alert alert-success mt-3">{{ mensajeExito }}</div>
  </div>

  <div *ngIf="!reservaForm.valid && !isLoadingTramos" class="alert alert-secondary mt-3">
    Por favor, complete todos los campos para ver los horarios.
  </div>
</div>
